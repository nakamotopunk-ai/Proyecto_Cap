<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest-admin.json">
    <title>Admin CAP - Gestión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #2dd4bf; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen p-4 pb-20 font-sans">
    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-white p-6 rounded-[2rem] border border-teal-100 shadow-xl">
            <div>
                <h1 class="text-xl font-black text-teal-600 italic uppercase tracking-tighter">Panel Administrativo CAP</h1>
                <p class="text-[9px] text-slate-400 font-bold tracking-[0.3em] uppercase italic">Dra. Gabriela Araujo</p>
            </div>
        </header>

        <div class="grid md:grid-cols-2 gap-6">
            <section class="bg-white p-6 rounded-[2.5rem] border border-teal-50 shadow-lg">
                <h2 class="text-xs font-black text-teal-700 uppercase mb-4 tracking-widest text-center italic underline decoration-teal-300">1. Habilitar Horarios</h2>
                <input type="date" id="adminDatePicker" class="w-full bg-teal-50 border-none rounded-2xl p-4 text-center font-bold text-teal-700 mb-6 outline-none ring-1 ring-teal-100 focus:ring-2 focus:ring-teal-400 transition-all">
                <div id="adminSlotsContainer" class="grid grid-cols-3 gap-2"></div>
                <button onclick="guardarConfiguracion()" class="w-full mt-6 bg-slate-900 hover:bg-teal-600 text-white font-black py-4 rounded-2xl transition-all uppercase text-[10px] tracking-widest shadow-xl active:scale-95">
                    Actualizar Disponibilidad
                </button>
            </section>

            <section class="bg-white p-6 rounded-[2.5rem] border border-teal-50 shadow-lg">
                <h2 class="text-xs font-black text-rose-500 uppercase mb-4 tracking-widest text-center italic underline decoration-rose-200">2. Citas Agendadas</h2>
                <div id="citasContainer" class="space-y-3 max-h-[500px] overflow-y-auto pr-2 custom-scroll">
                    <p class="text-center text-slate-400 text-[10px] py-10 uppercase font-bold italic">Cargando agenda...</p>
                </div>
            </section>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBpuxAj2uxWgZw3eucgbDzLe22lQpLw53U",
            authDomain: "agendacap-c03c7.firebaseapp.com",
            projectId: "agendacap-c03c7",
            storageBucket: "agendacap-c03c7.firebasestorage.app",
            messagingSenderId: "39895419484",
            appId: "1:39895419484:web:b7417e3e6ccd872febb499"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const horasBase = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "16:00", "17:00", "18:00", "19:00"];
        let horasSeleccionadas = [];
        let unsubscribeCitas = null;

        const dateInput = document.getElementById('adminDatePicker');
        
        // Ajuste para fecha local México (evita desfase de días)
        const ahora = new Date();
        const offset = ahora.getTimezoneOffset() * 60000;
        dateInput.value = new Date(ahora - offset).toISOString().split('T')[0];

        async function cargarDia(fecha) {
            const container = document.getElementById('citasContainer');
            
            // 1. Obtener configuración de horarios para ese día
            const configDoc = await getDoc(doc(db, "configuracion", fecha));
            horasSeleccionadas = configDoc.exists() ? configDoc.data().activos : [];
            renderAdminSlots();

            // 2. Escuchar citas (Ordenadas localmente para evitar errores de conexión)
            if (unsubscribeCitas) unsubscribeCitas();
            const q = query(collection(db, "citas"), where("fecha", "==", fecha));
            
            unsubscribeCitas = onSnapshot(q, (snap) => {
                container.innerHTML = '';
                
                if (snap.empty) {
                    container.innerHTML = '<div class="text-center py-10 text-slate-300 text-[10px] font-black uppercase italic">Sin citas agendadas</div>';
                    return;
                }
                
                // Procesar y ordenar localmente por hora
                const docs = [];
                snap.forEach(d => docs.push({id: d.id, ...d.data()}));
                docs.sort((a, b) => a.hora.localeCompare(b.hora));

                docs.forEach(cita => {
                    const waLink = `https://wa.me/523313111626?text=Hola ${encodeURIComponent(cita.nombre)}, te contacto de CAP sobre tu cita de las ${cita.hora}`;
                    container.innerHTML += `
                        <div class="bg-white p-4 rounded-2xl border border-teal-100 flex justify-between items-center shadow-md mb-2">
                            <div>
                                <p class="text-[8px] font-black text-teal-600 uppercase italic">${cita.hora}</p>
                                <h3 class="font-bold text-slate-800 text-xs uppercase">${cita.nombre}</h3>
                            </div>
                            <div class="flex gap-2">
                                <a href="${waLink}" target="_blank" class="bg-[#25D366] p-2.5 rounded-xl text-white">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.582 2.128 2.182-.573c.978.58 1.911.928 3.145.929 3.178 0 5.767-2.587 5.768-5.766 0-3.18-2.587-5.771-5.764-5.771zm3.392 8.244c-.144.405-.837.774-1.396.933-.551.162-1.201.101-1.744-.268-.543-.36-1.548-1.134-2.126-1.73-.578-.596-1.181-1.44-1.212-2.012-.03-.572.254-1.178.669-1.51.416-.334.911-.348 1.201-.348.29 0 .537.014.756.044.219.03.491.069.722.519.231.45.779 1.897.848 2.04z"/></svg>
                                </a>
                                <button onclick="window.eliminarCita('${cita.id}')" class="bg-rose-100 p-2.5 rounded-xl text-rose-500 hover:bg-rose-500 hover:text-white transition-all shadow-sm">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>`;
                });
            }, (err) => {
                container.innerHTML = `<p class="text-rose-500 text-[10px] font-bold">Error de conexión: Verifica Dominios Autorizados en Firebase.</p>`;
            });
        }

        function renderAdminSlots() {
            const container = document.getElementById('adminSlotsContainer');
            container.innerHTML = '';
            horasBase.forEach(hora => {
                const isActive = horasSeleccionadas.includes(hora);
                const btn = document.createElement('button');
                btn.innerText = hora;
                btn.className = `p-3 rounded-xl text-[10px] font-bold transition-all ${isActive ? 'bg-teal-500 text-white shadow-md' : 'bg-slate-100 text-slate-400 border border-slate-200'}`;
                btn.onclick = () => {
                    if (horasSeleccionadas.includes(hora)) horasSeleccionadas = horasSeleccionadas.filter(h => h !== hora);
                    else horasSeleccionadas.push(hora);
                    renderAdminSlots();
                };
                container.appendChild(btn);
            });
        }

        window.guardarConfiguracion = async () => {
            const fecha = document.getElementById('adminDatePicker').value;
            await setDoc(doc(db, "configuracion", fecha), { activos: horasSeleccionadas.sort() });
            alert("✅ Horarios actualizados.");
        };

        window.eliminarCita = async (id) => {
            if (confirm("¿Eliminar esta cita definitivamente?")) await deleteDoc(doc(db, "citas", id));
        };

        // Inicio
        cargarDia(dateInput.value);
        dateInput.addEventListener('change', (e) => cargarDia(e.target.value));
    </script>
</body>
</html>
